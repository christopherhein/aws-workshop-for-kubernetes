= Service Mesh Integration Using Linkerd
:toc:
:icons:
:linkcss:
:imagesdir: ../../../resources/images

https://linkerd.io/[Linkerd] is a layer 5/7 proxy that routes and load balances traffic over HTTP, Thrift, Mux, HTTP/2 and gRPC. Its based on Finagle (built by Twitter), and in January 2017 linkerd became a member of the link:https://www.cncf.io/[CNCF], alongside Kubernetes.

https://linkerd.io/[Linkerd] adds visibility, control, and reliability to your application with
a wide array of powerful techniques: circuit-breaking, latency-aware load balancing, eventually
consistent (“advisory”) service discovery, deadline propagation, and tracing and instrumentation.

In this exercise, we will focus on visibility for your services running in a Kubernetes cluster. We will
install linkerd in your k8s cluster, run a couple of simple microservices and demonstrate how
linkerd captures top-line service metrics such as success rates, request volumes and latencies.

In this exercise we'll look at a few of the features linkerd provides, such as:

. Monitoring the traffic within the service mesh
. Per request routing

=== Create Kubernetes cluster

This chapter uses a cluster with 3 master nodes and 5 worker nodes as described here: link:../cluster-install#multi-master-multi-node-multi-az-gossip-based-cluster[multi-master, multi-node gossip based cluster].

=== Install linkerd

Install linkerd using `kubectl`. This will install linkerd as a DaemonSet (i.e., one instance per
host) running in the default Kubernetes namespace.

  kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/linkerd.yml
  configmap "l5d-config" created
  daemonset "l5d" created
  service "l5d" created

Check that the linkerd (named as `l5d`) pods are running:

  $ kubectl get pods
  NAME        READY     STATUS    RESTARTS   AGE
  l5d-4kg47   2/2       Running   0          55s
  l5d-d0wvv   2/2       Running   0          55s
  l5d-gfpc7   2/2       Running   0          55s
  l5d-w0d95   2/2       Running   0          55s
  l5d-xppqs   2/2       Running   0          55s

This is the output shown from a 5 worker node cluster.

Check that the linkerd service is running:

  $ kubectl get svc
  NAME         TYPE           CLUSTER-IP     EXTERNAL-IP        PORT(S)                                        AGE
  kubernetes   ClusterIP      100.64.0.1     <none>             443/TCP                                        15h
  l5d          LoadBalancer   100.68.65.99   a306c8f52b92c...   4140:30609/TCP,4141:31489/TCP,9990:31710/TCP   24s

Get more details about linkerd service:

  $ kubectl describe svc/l5d
  Name:                     l5d
  Namespace:                default
  Labels:                   <none>
  Annotations:              kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"name":"l5d","namespace":"default"},"spec":{"ports":[{"name":"outgoing","port":4140},{...
  Selector:                 app=l5d
  Type:                     LoadBalancer
  IP:                       100.70.56.141
  LoadBalancer Ingress:     abf44db7dbe1211e7a7d00220684043f-1319890531.eu-central-1.elb.amazonaws.com
  Port:                     outgoing  4140/TCP
  TargetPort:               4140/TCP
  NodePort:                 outgoing  30108/TCP
  Endpoints:                100.96.3.2:4140,100.96.4.2:4140,100.96.5.4:4140 + 2 more...
  Port:                     incoming  4141/TCP
  TargetPort:               4141/TCP
  NodePort:                 incoming  31209/TCP
  Endpoints:                100.96.3.2:4141,100.96.4.2:4141,100.96.5.4:4141 + 2 more...
  Port:                     admin  9990/TCP
  TargetPort:               9990/TCP
  NodePort:                 admin  32117/TCP
  Endpoints:                100.96.3.2:9990,100.96.4.2:9990,100.96.5.4:9990 + 2 more...
  Session Affinity:         None
  External Traffic Policy:  Cluster
  Events:
    Type    Reason                Age   From                Message
    ----    ------                ----  ----                -------
    Normal  CreatingLoadBalancer  3m    service-controller  Creating load balancer
    Normal  CreatedLoadBalancer   3m    service-controller  Created load balancer

You can go to linkerd's admin page (i.e ELB:9990) to verify installation. It may take a minute or two before the
ELB DNS is available. If you have an issue accessing the load balancer endpoint, it could be because your firewall
or VPN is preventing access to port 9990.

  LINKERD_ELB=$(kubectl get svc l5d -o jsonpath="{.status.loadBalancer.ingress[0].*}")
  open http://$LINKERD_ELB:9990

The default dashboard looks like as shown:

image::linkerd-default-dashboard.png[]

=== Install sample microservices apps

The https://github.com/linkerd/linkerd-examples/tree/master/k8s-daemonset/k8s[Github repo for
linkerd examples] has two microservices apps called "`hello`" and "`world`". They both communicate
with each other to complete the request. Run this command to install these apps in the default
namespace.

  $ kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/hello-world.yml
  replicationcontroller "hello" created
  service "hello" created
  replicationcontroller "world-v1" created
  service "world-v1" created

Generate some traffic by running this command:

  http_proxy=$LINKERD_ELB:4140 curl -s http://hello

Linkerd will show the number of requests being served, connections and a bunch of rich data:

image::linkerd.png[]

=== Install linkerd-viz

https://github.com/linkerd/linkerd-viz[linkerd-viz] is a monitoring application based on https://prometheus.io/[Prometheus] and http://grafana.org/[Grafana]. It can automatically find linkerd instances and services
that are installed in your k8s cluster.

  $ kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-viz/master/k8s/linkerd-viz.yml
  replicationcontroller "linkerd-viz" created
  service "linkerd-viz" created

You can open linkerd-viz ELB to view the dashboard:

  LINKERD_VIZ_ELB=$(kubectl get svc linkerd-viz -o jsonpath="{.status.loadBalancer.ingress[0].*}")
  open http://$LINKERD_VIZ_ELB

As with the previous example, it may take a minute or two before the ELB DNS is available.

image::linkerd-viz.png[]

=== Per request routing

We'll use the same "`hello-world`" application used in the example above, but this time we'll deploy version 2 of the
"`world`" microservice, and we'll specify on a per request level whether the request should use v1 or v2 of the "`"world`" microservice.

If you haven't already deployed the "`hello-world`" application, deploy it now.

    kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
    k8s-daemonset/k8s/hello-world.yml

Deploy the linkerd ingress so we can access the application externally.

    $ kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
    k8s-daemonset/k8s/linkerd-ingress.yml
    configmap "l5d-config" configured
    daemonset "l5d" configured
    service "l5d" configured

Now deploy version2 of the "`world`" microservice.

    $ kubectl apply -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
    k8s-daemonset/k8s/world-v2.yml
    replicationcontroller "world-v2" created
    service "world-v2" created

Send a request to v1 of the service. It should reply with 'Hello world'.

    INGRESS_LB=$(kubectl get svc l5d -o jsonpath="{.status.loadBalancer.ingress[0].*}")
    curl -H 'Host: www.hello.world' $INGRESS_LB

After a minute or two, it should reply with `Hello world` as shown:

  Hello (100.96.1.12) world (100.96.1.14)

Now send a request to v2 of the service by modifying the header in the request.

    curl -H "Host: www.hello.world" -H "l5d-dtab: /host/world => /srv/world-v2;" $INGRESS_LB

It should reply with 'Hello earth' as shown:

  Hello (100.96.1.11) earth (100.96.2.14)

This demonstrates that v1 and v2 of the `world` service are running in the cluster, and you can specify in the
request header which version of the service to route individual requests to.

That's it!

You can look into linkerd configuration files in https://github.com/linkerd/linkerd-examples/tree/master/k8s-daemonset/k8s[linkerd examples] to learn more.

=== Cleanup

Remove the installed components:

  kubectl delete -f https://raw.githubusercontent.com/linkerd/linkerd-viz/master/k8s/linkerd-viz.yml
  kubectl delete -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/world-v2.yml
  kubectl delete -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/hello-world.yml
  kubectl delete -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/linkerd-ingress.yml
  kubectl delete -f https://raw.githubusercontent.com/linkerd/linkerd-examples/master/\
  k8s-daemonset/k8s/linkerd.yml

You are now ready to continue on with the workshop!

:frame: none
:grid: none
:valign: top

[align="center", cols="2", grid="none", frame="none"]
|=====
|image:button-continue-standard.png[link=../../02-path-working-with-clusters/202-service-mesh]
|image:button-continue-operations.png[link=../../02-path-working-with-clusters/202-service-mesh]
|link:../readme.adoc[Go to Standard Index]
|link:../readme.adoc[Go to Operations Index]
|=====
